services:
  app:
    build:
      context: .
      args:
        - INCLUDE_DEV=true
    platform: linux/amd64
    env_file:
      - .env
    volumes:
      - .:/app
      # Exclude the local venv so we don't mix Linux (container) and Mac (host) binaries
      - /app/.venv
    # Keep the container alive for debugging, or run the server
    command: api
    ports:
      - "8000:8000"

  dd-arbiter:
    # Use pre-built image from GHCR (fast!) or build locally if needed
    # To pull: docker compose pull dd-arbiter
    # To build: docker compose build dd-arbiter
    image: ghcr.io/albeorla/founder-mode/dd-arbiter:latest
    build:
      context: .
      dockerfile: apps/dd-arbiter/Dockerfile
    platform: linux/amd64
    env_file:
      - .env
    volumes:
      - .:/workspace
      # Persist caches to avoid re-downloading models
      - uv-cache:/root/.cache/uv
      - huggingface-cache:/root/.cache/huggingface
      - transformers-cache:/root/.cache/transformers
      # Exclude local venv
      - /workspace/.venv
    working_dir: /workspace/apps/dd-arbiter
    command: ["uv", "run", "python", "-m", "ddarbiter", "--help"]

volumes:
  uv-cache:
    driver: local
  huggingface-cache:
    driver: local
  transformers-cache:
    driver: local
